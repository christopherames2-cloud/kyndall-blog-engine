// kyndall-blog-engine/src/generator/article.js
// Generates GEO-optimized articles using Claude AI
// NOW WITH quickAnswer generation for featured snippets

import Anthropic from '@anthropic-ai/sdk'
import { getArticlePrompt, getFAQPrompt, getTakeawayPrompt, getTipsPrompt, getKyndallsTakePrompt } from './prompts.js'

let anthropic = null

function getClient() {
  if (!anthropic) {
    const apiKey = process.env.ANTHROPIC_API_KEY
    if (!apiKey) {
      throw new Error('Missing ANTHROPIC_API_KEY')
    }
    anthropic = new Anthropic({ apiKey })
  }
  return anthropic
}

/**
 * Generate a complete GEO-optimized article from a trending topic
 */
export async function generateArticle(trend) {
  const client = getClient()
  
  const topic = trend.topic || trend.title
  const platform = trend.platform
  const tags = trend.tags || []

  console.log(`      ðŸ¤– Generating article structure...`)

  // Step 1: Generate main article structure (now includes quickAnswer)
  const mainContent = await generateMainContent(client, topic, platform, tags)
  
  // Step 2: Generate FAQ section (critical for GEO)
  console.log(`      ðŸ¤– Generating FAQ section...`)
  const faqSection = await generateFAQSection(client, topic, mainContent.excerpt)
  
  // Step 3: Generate Key Takeaways
  console.log(`      ðŸ¤– Generating key takeaways...`)
  const keyTakeaways = await generateKeyTakeaways(client, topic, mainContent.excerpt)
  
  // Step 4: Generate Expert Tips
  console.log(`      ðŸ¤– Generating expert tips...`)
  const expertTips = await generateExpertTips(client, topic)
  
  // Step 5: Generate Kyndall's Take
  console.log(`      ðŸ¤– Generating Kyndall's perspective...`)
  const kyndallsTake = await generateKyndallsTake(client, topic, platform)

  // Determine category from content
  const category = determineCategory(topic, mainContent.content)

  return {
    title: mainContent.title,
    slug: generateSlug(mainContent.title),
    excerpt: mainContent.excerpt,
    quickAnswer: mainContent.quickAnswer, // NOW INCLUDED!
    introduction: mainContent.introduction,
    mainContent: mainContent.content,
    faqSection,
    keyTakeaways,
    expertTips,
    kyndallsTake,
    category,
    seoTitle: mainContent.seoTitle,
    seoDescription: mainContent.seoDescription,
    keywords: mainContent.keywords,
    autoGenerated: true,
    publishedAt: new Date().toISOString(),
  }
}

/**
 * Generate main article content
 */
async function generateMainContent(client, topic, platform, tags) {
  const prompt = getArticlePrompt(topic, platform, tags)
  
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 4000,
    messages: [{ role: 'user', content: prompt }],
  })

  const text = response.content[0].text
  
  // Parse the structured response
  return parseMainContentResponse(text, topic)
}

/**
 * Generate FAQ section
 */
async function generateFAQSection(client, topic, excerpt) {
  const prompt = getFAQPrompt(topic, excerpt)
  
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2000,
    messages: [{ role: 'user', content: prompt }],
  })

  const text = response.content[0].text
  
  try {
    const cleanText = cleanJsonResponse(text)
    const parsed = JSON.parse(cleanText)
    return parsed.faqs || []
  } catch (error) {
    console.log(`      âš ï¸ FAQ parse error, using fallback`)
    return [
      { question: `What is ${topic}?`, answer: `${topic} is a trending beauty topic that has been gaining popularity.` },
      { question: `Is ${topic} worth trying?`, answer: `It depends on your specific needs and preferences. Many people have found it helpful.` },
      { question: `How do I get started with ${topic}?`, answer: `Start by researching and understanding what works best for your situation.` },
    ]
  }
}

/**
 * Generate Key Takeaways
 */
async function generateKeyTakeaways(client, topic, excerpt) {
  const prompt = getTakeawayPrompt(topic, excerpt)
  
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 1500,
    messages: [{ role: 'user', content: prompt }],
  })

  const text = response.content[0].text
  
  try {
    const cleanText = cleanJsonResponse(text)
    const parsed = JSON.parse(cleanText)
    return parsed.takeaways || []
  } catch (error) {
    console.log(`      âš ï¸ Takeaways parse error, using fallback`)
    return [
      { icon: 'âœ¨', point: `${topic} is currently trending in the beauty community` },
      { icon: 'ðŸ’¡', point: `Research before diving in to find what works for you` },
      { icon: 'ðŸ’•', point: `Start small and build up gradually` },
    ]
  }
}

/**
 * Generate Expert Tips
 */
async function generateExpertTips(client, topic) {
  const prompt = getTipsPrompt(topic)
  
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 1500,
    messages: [{ role: 'user', content: prompt }],
  })

  const text = response.content[0].text
  
  try {
    const cleanText = cleanJsonResponse(text)
    const parsed = JSON.parse(cleanText)
    return parsed.tips || []
  } catch (error) {
    console.log(`      âš ï¸ Tips parse error, using fallback`)
    return [
      { 
        title: 'Start With Research', 
        description: `Before trying ${topic}, take time to understand what works best for your specific needs.`,
        proTip: null
      },
      { 
        title: 'Patch Test First', 
        description: 'Always do a patch test with new products to make sure your skin agrees.',
        proTip: 'The inside of your elbow is perfect for patch testing!'
      },
    ]
  }
}

/**
 * Generate Kyndall's Take
 */
async function generateKyndallsTake(client, topic, platform) {
  const prompt = getKyndallsTakePrompt(topic, platform)
  
  const response = await client.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 1000,
    messages: [{ role: 'user', content: prompt }],
  })

  const text = response.content[0].text
  
  try {
    const cleanText = cleanJsonResponse(text)
    const parsed = JSON.parse(cleanText)
    return {
      showKyndallsTake: true,
      headline: parsed.headline || "Kyndall's Take",
      content: parsed.content || `I've been seeing ${topic} everywhere and honestly? I'm intrigued.`,
      mood: parsed.mood || 'recommend',
    }
  } catch (error) {
    console.log(`      âš ï¸ Kyndall's Take parse error, using fallback`)
    return {
      showKyndallsTake: true,
      headline: "My Honest Take",
      content: `I've been seeing ${topic} all over my feed lately and I have thoughts! It's definitely worth exploring if you're curious.`,
      mood: 'recommend',
    }
  }
}

/**
 * Parse main content response
 */
function parseMainContentResponse(text, topic) {
  try {
    const cleanText = cleanJsonResponse(text)
    const parsed = JSON.parse(cleanText)
    
    return {
      title: parsed.title || `Everything You Need to Know About ${topic}`,
      excerpt: parsed.excerpt || `Let's talk about ${topic} and why everyone's obsessed right now.`,
      quickAnswer: parsed.quickAnswer || `${topic} is trending in the beauty community. Here's everything you need to know to get started and make it work for you.`,
      introduction: parsed.introduction || `If you've been on social media lately, you've probably seen ${topic} everywhere. Let me break it down for you.`,
      content: parsed.content || `## What is ${topic}?\n\nLet's dive into what makes ${topic} so popular right now.`,
      seoTitle: parsed.seoTitle || parsed.title || topic,
      seoDescription: parsed.seoDescription || parsed.excerpt || `Discover everything about ${topic}`,
      keywords: parsed.keywords || [topic.toLowerCase()],
    }
  } catch (error) {
    console.log(`      âš ï¸ Main content parse error, using fallback`)
    return {
      title: `Everything You Need to Know About ${topic}`,
      excerpt: `Let's talk about ${topic} and why everyone's obsessed right now.`,
      quickAnswer: `${topic} is currently trending. Here's a quick overview of what you need to know and why it's worth your attention.`,
      introduction: `If you've been on social media lately, you've probably seen ${topic} everywhere. Let me break it down for you.`,
      content: `## What is ${topic}?\n\nLet's dive into what makes ${topic} so popular right now.\n\n## Why It's Trending\n\nThere are several reasons why ${topic} has taken over our feeds.\n\n## How to Get Started\n\nReady to try it yourself? Here's what you need to know.`,
      seoTitle: topic,
      seoDescription: `Discover everything about ${topic}`,
      keywords: [topic.toLowerCase()],
    }
  }
}

/**
 * Clean JSON response (remove markdown code blocks)
 */
function cleanJsonResponse(text) {
  return text
    .replace(/```json\s*/gi, '')
    .replace(/```\s*/gi, '')
    .trim()
}

/**
 * Generate URL slug from title
 */
function generateSlug(title) {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '')
    .substring(0, 96)
}

/**
 * Determine category from topic and content
 */
function determineCategory(topic, content) {
  const text = `${topic} ${content}`.toLowerCase()
  
  const categoryKeywords = {
    makeup: ['makeup', 'lipstick', 'foundation', 'mascara', 'eyeshadow', 'blush', 'bronzer', 'concealer', 'contour', 'highlighter', 'brow', 'lash', 'liner'],
    skincare: ['skincare', 'skin care', 'serum', 'moisturizer', 'cleanser', 'toner', 'retinol', 'vitamin c', 'hyaluronic', 'spf', 'sunscreen', 'acne', 'pores', 'wrinkles', 'anti-aging'],
    hair: ['hair', 'haircare', 'shampoo', 'conditioner', 'styling', 'curls', 'straighten', 'color', 'highlights', 'balayage'],
    fashion: ['fashion', 'style', 'outfit', 'clothes', 'dress', 'jeans', 'shoes', 'accessories', 'trend'],
    wellness: ['wellness', 'health', 'fitness', 'meditation', 'yoga', 'mental health', 'self care', 'sleep', 'nutrition'],
    lifestyle: ['lifestyle', 'home', 'decor', 'organization', 'routine', 'productivity', 'travel'],
  }
  
  let bestMatch = 'lifestyle'
  let bestScore = 0
  
  for (const [category, keywords] of Object.entries(categoryKeywords)) {
    const score = keywords.filter(kw => text.includes(kw)).length
    if (score > bestScore) {
      bestScore = score
      bestMatch = category
    }
  }
  
  return bestMatch
}
